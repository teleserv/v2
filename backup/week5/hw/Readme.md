# HW 5: Training a Generative Adversarial Network

Generative Adversarial Networks (GAN) are a special kind of neural network that can learn a data probability distribution under unsupervised learning. Essentially, a GAN draws from a dataset to generate its own data. A GAN is made up of a generator (that generates data) and a discriminator (that discriminates between "real" data from the dataset and "fake" data generated by the generator). A feature vector called "z" in this case is a representation of the data, which is used to generate images and even images with chosen attributes. In this homework, we will create a GAN based on the CelebA dataset to apply z vector attributes to faces.

## Setting up GAN Compatibility on DIGITS and the CelebA Dataset

For this job we will once again train in the cloud. Set up a VS with the same attributes as in week 2 (refer to the [instructions](https://github.com/MIDS-scaling-up/v2/tree/master/week2/hw) if you don't remember). Set up everything but don't create the DIGITS container yet. 

### Downloading the CelebA Dataset

Once the VS has been provisioned, enter it via ssh and run the following command to download the CelebA dataset zip (do this in the "/data" directory, which is the mounted drive)
```
wget --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=0B7EVK8r0v71pZjFTYXZWM3FlRnM' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=0B7EVK8r0v71pZjFTYXZWM3FlRnM" -O img_align_celeba.zip& rm -rf /tmp/cookies.txt
```
Install unzip and unzip the file:
```
sudo apt-get install unzip
unzip img_align_celeba.zip
```
Download the file list, also stored within the /data directory:
```
wget --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate 'https://docs.google.com/uc?export=download&id=0B7EVK8r0v71pblRyaVFSWGxPY0U' -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1\n/p')&id=0B7EVK8r0v71pblRyaVFSWGxPY0U" -O list_attr_celeba.txt& rm -rf /tmp/cookies.txt
```

### Setting Up the GAN Plugin in DIGITS

DIGITS doesn't have GAN compatibility as default, so we'll have to install the GAN plugin and visualization data manually. Make sure you are still in the VS via ssh. First, login to nvcr.io and then create the DIGITS image with the CelebA dataset and file list mounted:
```
docker login nvcr.io
nvidia-docker run --shm-size=1g --ulimit memlock=-1 --name digits -d -p 8888:5000 -v /data:/data -v /data/digits-jobs:/workspace/jobs nvcr.io/nvidia/digits:18.06
```
Enter the DIGITS container, replacing the <> with the container ID (you can check with `docker ps -a`):
```
docker exec -it <containerID> /bin/bash
```
While inside the container, install the GAN plugins and visualization data:
```
pip install -e /opt/digits
pip install -e /opt/digits/plugins/data/gan/
pip install -e /opt/digits/plugins/view/gan/
```
Exit the container, stop it, then start it up again with the `docker stop` and `docker start` commands. Check your VS IP address and access DIGITS on your browser at `<VSipaddress>:8888`.

## Training the GAN and GAN Encoder on CelebA

The GAN must be trained in a certain way differently from the regular model we did in week 2. We will also be training a GAN encoder model that can generate a z vector based on input images. Each model takes around 3 hours to train, so leave adequate time to finish.

### Creating the Dataset and Training the GAN

Navigate to the "New Dataset" tab, choose the "Images" blue tab, and select "GAN" in the drop-down menu. In the next screen, make sure to specify the locations of the file list and image folder (which should be in the /data directory you mounted). Leave other settings in default and create the dataset.

When the dataset is finished, go back to the DIGITS home page. Go to the "New Model" tab, click the "Images" blue tab, and select "Other". Select the dataset previously created, set the epochs to 60, set batch size to 64, set mean subtraction to "None", select "ADAM" solver, select learning rate to "5e-4", and use only 1 GPU to train. Choose to use a Custom Network, select "Tensorflow", and copy-paste this [network definition](https://github.com/NVIDIA/DIGITS/blob/master/examples/gan/network-celebA.py) in the blank space. Give an appropriate group and model name, then create the model. Note how the graph differs over time compared to the one for the model trained in week 2. 

### Training the GAN Encoder

An encoder is desired since it can be trained to generate a z vector based on on input images. To create one, select the previously created GAN model in the home page and click "Clone Job" in the upper-right corner. Leave all the parameters as the same, but select the "Previous Networks" tab. Select the created GAN model, choose the last epoch, and click "Customize". In the blank space, copy+paste this [network definition](https://github.com/NVIDIA/DIGITS/blob/master/examples/gan/network-celebA-encoder.py). Create the encoder model.

## Testing the GAN and GAN Encoder for CelebA

Using the GAN and GAN encoder just created, we can generate new images by adding desired attributes to the base images in the CelebA dataset.

### Collecting a Z Vector from an Image

The CelebA dataset has 40 different attributes for each image. The GAN plugin includes a script that can sweep through all images and generate 40 z vectors, each corresponding to an attribute. To run this, first check the job ID of the GAN encoder job by selecting it from the home screen and reading the info in the upper-left side. Enter the DIGITS container using `docker exec` like before, then run the following (replace the <> with the job ID):
```
./opt/digits/examples/gan/gan_features.py -j /workspace/jobs/ /workspace/jobs/<jobID>/ -g 0
```
This might take some time. Once finished, open DIGITS on the browser. Open the GAN Encoder model job page. Scroll down to the "Trained Models" section, select the "GAN" visualization method and "CelebA Encoder" task from the corresponding drop-down menus. Select the "GAN" inference form, the "CelebA" dataset, and the "Encode list of images" task ID. Choose the same file list and image folder as when creating the CelebA dataset. With all these settings, click `Test`, which should open a new tab. The new tab will include a list of all the CelebA images and the corresponding z vectors for each. Choose one of the images and make note of its z vector somewhere for use later. 

### Generating Images with Added Attributes

Go back to the DIGITS home page and select the GAN model job page. Going to the "Trained Models" section, select the "Image output" visualization method and set Data order to "HWC". Choose the GAN inference form and the "add/remove attributes" task. Make sure to specify the location of the attributes vector file and paste in the z vector you obtained in the previous step. Click the "Add row" to add a output image. For each row, you should see several attributes, such as "Bald" or "Black_Hair". In each corresponding box, put a +1 or -1 (or other number) to either add or remove the attribute respectively. Click "Test" to see the results for each output image. How well does it work? Experiment with different combinations and magnitudes to see how well each works. 




 
